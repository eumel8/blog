---
layout: post
tag: general
title: Single Sign On mit OpenSSO, Josso & Co.
subtitle: "Die letzte grosse Herausforderung im Internet ist die Information von Passwoertern und Accounts bei verschiedenen Webservices und Anbietern. Egal ob beruflich oder privat: Die Liste der zu verwaltenden Accounts, die einem bei dem einen oder anderen Anbi&hellip;"
date: 2011-04-11
author: eumel8
---

<p>Die letzte grosse Herausforderung im Internet ist die Information von Passwoertern und Accounts bei verschiedenen Webservices und Anbietern. Egal ob beruflich oder privat: Die Liste der zu verwaltenden Accounts, die einem bei dem einen oder anderen Anbieter zugeteilt wird und deren Information man sich am liebsten merken sollte, wird immer laenger. Neulich erzaehlte mir ein Kollege, dass er sich jeden Monat 256 Passwoerter von verschiedenen webgestuetzen Tools oder Webseiten merken muss. Und am liebsten die Passwoerter auch einmal im Monat aendern soll. Gott bewahre!</p>

<br/>

<p>Der Trend geht dann eindeutig dazu, dass man ueberall dasselbe Passwort verwendet (sofern man einen laesst) oder nur noch einfach zu merkende Passwoerter verwendet. Dadurch wird natuerlich das blanke Gegenteil erreicht. Man wollte doch eigentlich Sicherheit verbreiten und scheitert weniger an der Bequemlichkeit der Benutzer als vielmehr deren Unvermoegen und Unverstaendnis.</p>
<p>Deswegen sehe ich es als letzte grosse Herausforderung an, sich einmal ins "Internet" einzuloggen und dann auch Zugriff auf <strong>seine</strong> Informationen zu haben. Ein paar Ansaetze gibts schon in der Vergangenheit:</p>
<ol>
<li>Passwortspeicher im Browser (immer noch sehr beliebt, bloed nur, wenn man sich des Passworts nicht mehr erinnern kann und sich von einem anderen Rechner oder Device einloggt)</li>
<li>OpenID. Das erstere groessere Konzept fuer Single Sign On. Es gibt OpenID-Provider wie http://meinguter.name<cite></cite><span class="f"><cite></cite></span>, bei denen mans ich einen Account anlegt. Fortan kann man sich ueber eine URL des OpenID-Providers bei einem System anmelden, welches selbst keine direkte Benutzerverwaltung hat, aber OpenID als Service anbieten wie http://mein.wunschzettelchen.org. wunschzettelchen.org reichert nur das Account-Profile an mit den Wunschzettelchen, welche zu einem bestimmten OpenID-Account gehoeren. Selbst werden aber keine Accountinformationen wie Passwoerter usw. gespeichert. Coole Sache, leider duempelt das Projekt so bischen vor sich hin.</li>
<li>OAuth. Die Fortsetzung des OpenID bei Twitter, Google, Yahoo und Co. </li>
</ol>
<p>Das Konzept heisst also Single Sign On - ein Account fuer alles. Dazu brauche ich erstmal eine beliebig grosse Anzahl von passwortgestuetzen Webseiten, die ich alle in meiner Hoheit habe und den Wunsch, das alles zu zentralisieren und die SIcherheit zu erhoehen.</p>
<p>OpenSSO ist, oder vielmehr war eine Enterprise-Loesung zum Identitymanagement von Oracle/SUN. Zugrunde liegt eine Java-Applikation mit SUN-Directory-Server als Config-Store und Auth-Store. Der Dienst ist ueber eine zentrale Internetadresse erreichbar. Die zu sicherenden Webservices bekommen einen Agent verpasst. Zwischen Agents und OpenSSO-Server werden Agreements ausgehandelt in Form von Namen und Passwoertern, mit denen den Agents erlaubt werden, mit dem OpenSSO-Server zusammenzuarbeiten.Das Prinzip ist dann recht einfach: Ich moechte Service A benutzen, dieser kennt mich nicht, schickt meine Anfrage zum OpenSSO-Service, der fordert mich auf einzuloggen und schickt dann bei Erfolg meine Credentials in Form eines Session-Cookies zum Service A zurueck. Unter der Hand haben die zwei dann ausgehandelt, dass das mit dem Session-Cookie ich bin. Das Logout funktioniert dann aehnlich. OpenSSO wird heute von http://forgerock.com als OpenAM weiterentwickelt.</p>
<p>Josso ist eine aehnliche Loesung wie OpenSSO - nur etwas leichtgewichtiger. Das tut dem Funktionsumfang aber keinen Abbruch. Josso gibt es als Webapp im Webcontainer von http://www.josso.org. Auf http://sourceforge.net/projects/josso/ gibt es aber auch fertig konfigurierte Tomcats mit der Josso-Webapp. Einfach die neuste Version runterladen, und auspacken, java-runtime jre auf dem Linux-System seiner Wahl installieren und dann gehts fast los.In /usr/local/apache-tomcat-6.0.29_josso-1.8.3/lib sind noch ein paar Anpassungen notwendig:</p>
<p>josso-gateway-config.xml: Hier sind weitere Config-Dateien fuer Identity-Stores zu definieren. Wahlweise brauchen wir den josso-gateway-ldap-stores.xml oder josso-gateway-db-stores.xml, den wir in die Datei einbinden muessen. LDAP oder ActiveDirectory waer zwar schick, aber ich beschreibe das Vorgehen mal an einer relationalen Datenbank. Altbacken habe ich mich fuer MySQL entschieden und habe in josso-gateway-db-stores.xml die Connect-Parameter zu konfigurieren:</p>
<pre>    <db-istore:jdbc-store<br />            id="josso-identity-store"<br />            driverName="com.mysql.jdbc.Driver"<br />            connectionURL="jdbc:mysql://192.168.0.10:3306/ben"<br />            connectionName="josso"<br />            connectionPassword="josso"<br />           [...]<br /></pre>
<p>Damit die Verbindung klappt. muss ich noch den konfigurierten MySQL-JDBC-Treiber von mysql.com herunterladen und ins selbe Verzeichnis kopieren: mysql-connector-java-5.1.15-bin. Ausserdem brauche ich noch eine MySQL-Datenbank. Das Beispielschema ist fuer Oracle und muss etwas angepasst werden (varchar statt varchar2). Ausserdem sind die Felder fuer Login etwas zu klein. Hier ist ein Beispiel fuer MySQL:</p>
<blockquote>
<p>DROP TABLE IF EXISTS `JOSSO_ROLE`;<br />CREATE TABLE `JOSSO_ROLE` (<br /> `NAME` varchar(16) NOT NULL,<br /> `DESCRIPTION` varchar(64) default NULL,<br /> PRIMARY KEY  (`NAME`)<br />) ENGINE=MyISAM DEFAULT CHARSET=latin1;<br /><br />--<br />-- Table structure for table `JOSSO_USER`<br />--<br /><br />DROP TABLE IF EXISTS `JOSSO_USER`;<br />CREATE TABLE `JOSSO_USER` (<br /> `LOGIN` varchar(16) NOT NULL,<br /> `PASSWORD` varchar(64) default NULL,<br /> `NAME` varchar(64) default NULL,<br /> `DESCRIPTION` varchar(64) default NULL,<br /> `EMAIL` varchar(64) NOT NULL,<br /> PRIMARY KEY  (`LOGIN`)<br />) ENGINE=MyISAM DEFAULT CHARSET=latin1;<br /><br />--<br />-- Table structure for table `JOSSO_USER_PROPERTY`<br />--<br /><br />DROP TABLE IF EXISTS `JOSSO_USER_PROPERTY`;<br />CREATE TABLE `JOSSO_USER_PROPERTY` (<br /> `LOGIN` varchar(16) NOT NULL,<br /> `NAME` varchar(255) NOT NULL,<br /> `VALUE` varchar(255) NOT NULL,<br /> PRIMARY KEY  (`LOGIN`,`NAME`)<br />) ENGINE=MyISAM DEFAULT CHARSET=latin1;<br /><br />--<br />-- Table structure for table `JOSSO_USER_ROLE`<br />--<br /><br />DROP TABLE IF EXISTS `JOSSO_USER_ROLE`;<br />CREATE TABLE `JOSSO_USER_ROLE` (<br /> `LOGIN` varchar(16) NOT NULL,<br /> `NAME` varchar(255) NOT NULL,<br /> PRIMARY KEY  (`LOGIN`,`NAME`),<br /> KEY `NAME` (`NAME`)<br />) ENGINE=MyISAM DEFAULT CHARSET=latin1;<br /><br /></p>
</blockquote>
<p>Es werden also nicht nur Username und Passwort sondern auch verschiedene Rollen in der Datenbank vorgehalten, in die ich User einweisen kann (role1, role2 gibts schon als Beispiel in der Originaltabelle von http://www.josso.org/confluence/display/JOSSO1/Database+Setup</p>
<p> </p>
<p>In der josso-gateway-selfservices.xml konfigurieren wir noch das Versenden von Freischaltmails bei vergessenem Passwort. Das wird spaeter die Kernfunktionalitaet unseres Dienstes. In die Datei gehoert ein Mailtemplate (Beispieldatei passwordVerificationEmail.vm) und Angaben zum versendenden Mailserver und Mailabsendeinformationen.</p>
<p>Unser Webservice soll unter SSL erreichbar sein. In Tomcat gibts da 2 Moeglichkeiten. Die erste ist die Verwendung von keytool aus dem jdk-Packet. Damit wird ein Tomcat-eigenes Zertifikatformat erstellt, die zum Beispiel mit OpenSSL nicht identisch ist. Der Umwandlung der Zertifikate ist ... aeh, abenteuerlich. Um OpenSSL im Tomcat verwendenzu koennen, muss das Tomcat Native Paket installiert werden. Unter Opensuse 11 findet man es als libtcnative-1-0, in OpenSuse 10 hilft nur selber bauen und installieren des tomcat-native-1.1.20-src.tar.gz. Wenn die Libs in das Java, welches im Tomcat Verwendung findet, eingebunden sind, kann ich in</p>
<p>/usr/local/src/apache-tomcat-6.0.29_josso-1.8.3/conf/server.xml einen SSL-Connector via APR AJP mit OpenSSL-Zertifikaten konfigurieren:</p>
<blockquote><Connector port="8443" maxHttpHeaderSize="8192"<br /> maxThreads="150"<br /> enableLookups="false" disableUploadTimeout="true"<br /> acceptCount="100" scheme="https" secure="true"<br /> SSLEnabled="true" <br /> SSLCertificateFile="/etc/apache2/server.crt"<br /> SSLCertificateKeyFile="/etc/apache2/server.key" /><br /> <br /><br /> <!-- Define an AJP 1.3 Connector on port 8009 --><br /> <Connector port="8009" protocol="AJP/1.3" redirectPort="8443"/><br /></blockquote>
<p> </p>
<blockquote>
<p>/usr/local/apache-tomcat-6.0.29_josso-1.8.3/bin/startup.sh</p>
</blockquote>
<p>Unser Tomcat wird gestartet. http://192.168.0.41:8080/josso/signon/login.do</p>
<p>Josso-Agents laufen auf den zu schuetzenden Applikationen, die zur Authentifierung den SSO-Server nutzen sollen. Wir benoetigen josso-apache22-agent-1.8.3-.tar.gz. Dort gibt es eine Fuelle fuer Agents in verschiedenen Applikationen. Fuer Apache 2.2 muessen wir den Agent mit Angabe des Apache APR und Verwendung der OpenSSL-Libs kompilieren. Man brauch also apache2-devel und openssl-devel-Pakete. Die kompilierte Lib kann ich /etc/apache2/conf.d/josso.conf einbinden:</p>
<pre>LoadModule auth_josso_module /usr/lib/apache2/libmod_auth_josso.so<br /><br /></pre>
<p>Ein "make install" wird zwar in /etc/sysconfig/apache2 das Modul automatisch versuchen einzubinden, aber irgendwie funktioniert das unter Suse nicht so richtig. Das zu schuetzende Verzeichnis wird dann in der httpd.conf bepuschelt:</p>
<p> </p>
<pre>  <Directory "/http/virtual/www.eumel.net/geheim"><br />    AuthType JOSSO<br />    AuthName "MyApacheWeb"</pre>
<pre>   Require role "role2"<br />    GatewayLoginUrl "https://192.168.0.41/josso/signon/login.do"<br />    GatewayLogoutUrl "https://192.168.0.41/josso/signon/logout.do"<br /> GatewayEndpoint "192.168.0.41" 443<br /> GatewayEndpointSSLEnable On<br />    SessionAccessMinInterval 60000<br />   </Directory></pre>
<p>Nach Apache-Restart sollten wir nach Aufruf unserer Geheim-URL zum SSO-Service weitergeleitet werden, dort unsere Credentials eingeben und per Redirect dann in unserem loginpflichtigen Bereich landen. Der Clou: Mit dem gespeicherten Session-Cooki und der Funktion "angemeldet bleiben" kann ich diesen Bereich ohne Eingabe des Passworts am SSO-Server immer und immer wieder aufrufen. Mein Apache-Webserver wird bei jedem Aufruf die Credentials aka Cookies am SSO-Sevrer auf Gueltigkeit ueberpruefen. Und wenn ich das Cookie verlorenhabe, kann ich ueber die Funktion "Passwort vergessen" mir vom SSO-Server ein neues per Mail zuschicken lassen und per Freischaltlink freischalten.</p>
